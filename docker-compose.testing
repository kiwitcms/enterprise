version: '2'

services:
    openldap_server:
        container_name: openldap_server
        # image: kiwitcms/openldap:2441-centos7-aarch64
        image: kiwitcms/openldap:2441-centos7-x86_64
        restart: always
        ports:
            - 389:389
            - 636:636

    db:
        container_name: db
        image: postgres:latest
        restart: always
        volumes:
            - db_data:/var/lib/postgresql/data
        environment:
            POSTGRES_DB: dummy_db
            POSTGRES_USER: dummy_usr
            POSTGRES_PASSWORD: dummy_s3cr3t

    web:
        container_name: web
        image: quay.io/kiwitcms/enterprise:latest
        depends_on:
            - db
            - openldap_server
        restart: always
        volumes:
            - ./test_settings.py:/venv/lib64/python3.11/site-packages/tcms_settings_dir/test_settings.py:z,ro
            - kiwi_ssl:/Kiwi/ssl:Z
            - kiwi_uploads:/Kiwi/uploads:Z
            - kiwi_letsencrypt:/etc/letsencrypt:Z
        environment:
            NGX_UPLOADS_RATE: 55
            NGX_UPLOADS_BURST: 20
            KIWI_TENANTS_DOMAIN: testing.example.bg
            DATABASE_URL: postgres://dummy_usr:dummy_s3cr3t@db:5432/dummy_db
        # Note: generated by testing/start_keycloak.sh
        env_file:
            - /tmp/kc.env

volumes:
    db_data:
    kiwi_ssl:
    kiwi_uploads:
    kiwi_letsencrypt:
